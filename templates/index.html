<!DOCTYPE html>
<html>

<head>
    <title>IQ gazebo terrain</title>
    <!-- <link rel="icon" type="image/png" href="img/favicon.ico">
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css">
    </link> -->
    <!-- CSS only -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script defer
        src="http://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AvxKz2fJzNCdBerfw1sxxNGJjbsUQwxnnZL9oy_nrgIMSvQ9ta-6IWZGWuS7SVqm"></script>
    <!-- <script type='text/javascript' src='http://www.bing.com/api/maps/mapcontrol?callback=GetMap' async defer></script> -->
</head>


<body>
    <nav class="navbar navbar-expand-md navbar-light bg-light">
        <a class="navbar-brand" href="#">Intelligent Quads</a>
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Link</a>
            </li>
        </ul>
    </nav>

    <div class="container">
        <h3>Intelligent Quads Gazebo Terrain Generator <b>BETA</b></h3>
        <div id="myMap" style="position:relative;width:600px;height:400px;"></div>
        <!-- <p>Search by name or coordinates</p>
        <form>
            <input type="text" id="modelName">
            <input type="submit">
        </form>
        <form>
            <label>Lat </label>
            <input type="text">
            <label>Lon </label>
            <input type="text">
            <input type="submit">
        </form> -->
        <br>
        <!-- <form>
            <label>Gazebo Model Name</label>
            <input type="text" id="modelName"> -->
        <button onclick="generate()">Generate</button>
        <!-- </form> -->

        <img style="visibility:hidden;" id="loadingImg" src="static/img/loading.gif" height="50" />
    </div>
    <!-- <div id="map" height="300"></div> -->
    <!-- <input type='button' id='download' value='Download'> -->
    <a hidden id="download" download="" href="static/cedar_point2.zip">download</a>
</body>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script type='text/javascript'>
    var map;
    var requestFile;
    function generate() {
        document.getElementById("loadingImg").style.visibility = 'visible';
        var center = map.getCenter()
        jsonData = { "latitude": center["latitude"], "longitude": center["longitude"] }
        console.log("generating")
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: "/generate",
            data: JSON.stringify(jsonData),
            success: function (data) {
                console.log(data['filename'])
                document.getElementById('download').href = 'static/' + data['filename']
                document.getElementById('download').click();
                console.log("downloading")
                document.getElementById("loadingImg").style.visibility = 'hidden';
            },
            dataType: "json"
        })
    }

    function updateBBox(centerLat, centerLon, width) {
        Microsoft.Maps.loadModule("Microsoft.Maps.SpatialMath", function () {
            console.log("getting location")
            var loc = new Microsoft.Maps.Location(centerLat, centerLon)
            var location = Microsoft.Maps.SpatialMath.getDestination(loc, 45, (width / 2) * Math.sqrt(2), Microsoft.Maps.SpatialMath.Meters)
            bboxNlat = location["latitude"];
            bboxElon = location["longitude"];
            console.log(location)
            console.log("location lat", location["latitude"])

            var location = Microsoft.Maps.SpatialMath.getDestination(loc, 225, (width / 2) * Math.sqrt(2), Microsoft.Maps.SpatialMath.Meters)
            bboxSlat = location["latitude"];
            bboxWlon = location["longitude"];
            console.log(location)
            console.log("got location")

            var myGeoJson = {
                "type": "Polygon",
                "coordinates": [[
                    [bboxWlon, bboxSlat],
                    [bboxWlon, bboxNlat],
                    [bboxElon, bboxNlat],
                    [bboxElon, bboxSlat],
                    [bboxWlon, bboxSlat]
                ]]
            };
            Microsoft.Maps.loadModule('Microsoft.Maps.GeoJson', function () {
                //Parse the GeoJson object into a Bing Maps shape.
                var shape = Microsoft.Maps.GeoJson.read(myGeoJson, {
                    polygonOptions: {
                        fillColor: 'rgba(255,0,0,0.5)',
                        strokeColor: 'white',
                        strokeThickness: 5
                    }
                });
                map.entities.clear();
                //Add the shape to the map.
                map.entities.push(shape);
            });
        });

    }

    function GetMap() {
        start_loc = [47.642, -122.128];
        map = new Microsoft.Maps.Map('#myMap', {
            credentials: "AvxKz2fJzNCdBerfw1sxxNGJjbsUQwxnnZL9oy_nrgIMSvQ9ta-6IWZGWuS7SVqm",
            mapTypeId: Microsoft.Maps.MapTypeId.aerial,
            center: new Microsoft.Maps.Location(start_loc[0], start_loc[1]),
            zoom: 15
        });
        updateBBox(start_loc[0], start_loc[1], 400)

        var width = 400;
        var bboxWlon = 0;
        var bboxElon = 0;
        var bboxNlat = 0;
        var bboxSlat = 0;
        Microsoft.Maps.Events.addHandler(map, 'viewchange', function (e) {
            var center = map.getCenter()
            updateBBox(center["latitude"], center["longitude"], 400)
        });

    }
</script>


</html>